<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="woojooin.planitbatch.domain.mapper.IsaTaxSavingMapper">
    <!-- ISA 계좌 상품 목록을 회원별로 그룹핑해서 조회 -->
    <select id="selectIsaProductProfitByMember"
            resultType="woojooin.planitbatch.domain.dto.UserProductQuarterData">

        SELECT member_id                   AS memberId,
               CONCAT(year, '-Q', quarter) AS quarter,
               total_profit                AS totalProfit
        FROM (SELECT mp.member_id,
                     YEAR(p.base_date)    AS year,
                     QUARTER(p.base_date) AS quarter,
                     SUM(
                             COALESCE(p.closing_price, 0) * COALESCE(mp.quantity, 0)
                                 - COALESCE(mp.purchase_amount, 0)
                     )                    AS total_profit
              FROM member_product mp
                       JOIN product p ON mp.product_id = p.shorten_code
              WHERE p.base_date IS NOT NULL
              GROUP BY mp.member_id, YEAR(p.base_date), QUARTER(p.base_date)) sub

    </select>


    <insert id="upsertIsaTaxSavingHistory" parameterType="woojooin.planitbatch.domain.vo.IsaTaxSavingHistoryVo">
        INSERT INTO isa_tax_saving_history (member_id, quarter, isa_profit, general_tax, tax_saved)
        VALUES (#{memberId}, #{quarter}, #{isaProfit}, #{generalTax}, #{taxSaved})
        ON DUPLICATE KEY UPDATE isa_profit  = VALUES(isa_profit),
                                general_tax = VALUES(general_tax),
                                tax_saved   = VALUES(tax_saved)
    </insert>

    <insert id="upsertIsaTaxSavingHistoryBatch" parameterType="java.util.List">
        INSERT INTO isa_tax_saving_history (member_id, quarter, isa_profit, general_tax, tax_saved)
        VALUES
        <foreach collection="items" item="item" separator=",">
            (#{item.memberId}, #{item.quarter}, #{item.isaProfit}, #{item.generalTax}, #{item.taxSaved})
        </foreach>
        ON DUPLICATE KEY UPDATE
        isa_profit = VALUES(isa_profit),
        general_tax = VALUES(general_tax),
        tax_saved = VALUES(tax_saved)
    </insert>


</mapper>


